--- cfg-common-opts.h.org	2009-09-30 01:01:08.055998916 -0400
+++ cfg-common-opts.h	2009-09-30 01:03:01.855997027 -0400
@@ -270,6 +270,9 @@
 	{"xvidopts", xvid_dec_opts, CONF_TYPE_SUBCONFIG, 0, 0, 0, NULL},
 #endif
 	{"codecs-file", &codecs_file, CONF_TYPE_STRING, 0, 0, 0, NULL},
+
+        //Auto-detect AC3 channels with -af lavcac3enc
+        {"lavc_ac3_detect", &lavc_ac3_detect, CONF_TYPE_INT, 0, 0, 0, NULL},
 // ------------------------- subtitles options --------------------
 
 	{"sub", &sub_name, CONF_TYPE_STRING_LIST, 0, 0, 0, NULL},
--- cfg-common.h.org	2009-03-30 12:33:35.000000000 -0400
+++ cfg-common.h	2009-03-30 12:34:49.000000000 -0400
@@ -23,6 +23,8 @@
 extern int field_dominance;
 
 /* from dec_audio, currently used for ac3surround decoder only */
+extern int lavc_ac3_detect;
+extern int lavc_ac3_num_detected;
 extern int audio_output_channels;
 extern int fakemono;
 
--- mplayer.c.org	2009-09-30 01:01:15.619997631 -0400
+++ mplayer.c	2009-09-30 01:03:01.861213892 -0400
@@ -3515,6 +3515,11 @@
     mp_msg(MSGT_IDENTIFY,MSGL_INFO,"ID_AUDIO_BITRATE=%d\n", mpctx->sh_audio->i_bps*8);
     mp_msg(MSGT_IDENTIFY,MSGL_INFO,"ID_AUDIO_RATE=%d\n", mpctx->sh_audio->samplerate);
     mp_msg(MSGT_IDENTIFY,MSGL_INFO,"ID_AUDIO_NCH=%d\n", mpctx->sh_audio->channels);
+    if (lavc_ac3_detect) {
+      mp_msg(MSGT_IDENTIFY,MSGL_INFO,"Autodetecting number of channels=%d\n", mpctx->sh_audio->channels);
+      audio_output_channels = mpctx->sh_audio->channels;
+      lavc_ac3_num_detected = mpctx->sh_audio->channels;
+    }
   }
   mp_msg(MSGT_IDENTIFY,MSGL_INFO,"ID_LENGTH=%.2lf\n", demuxer_get_time_length(mpctx->demuxer));
   mp_msg(MSGT_IDENTIFY,MSGL_INFO,"ID_SEEKABLE=%d\n",
--- libmpcodecs/dec_audio.c.org	2009-09-30 01:01:22.641999311 -0400
+++ libmpcodecs/dec_audio.c	2009-09-30 01:03:01.898998309 -0400
@@ -30,6 +30,8 @@
 /* used for ac3surround decoder - set using -channels option */
 int audio_output_channels = 2;
 af_cfg_t af_cfg = { 1, NULL };	// Configuration for audio filters
+extern int lavc_ac3_detect;
+extern int lavc_ac3_num_detected;
 
 void afm_help(void)
 {
@@ -114,6 +116,10 @@
     mp_msg(MSGT_IDENTIFY, MSGL_INFO,
 	   "ID_AUDIO_BITRATE=%d\nID_AUDIO_RATE=%d\n" "ID_AUDIO_NCH=%d\n",
 	   sh_audio->i_bps * 8, sh_audio->samplerate, sh_audio->channels);
+    if ((lavc_ac3_detect) && (lavc_ac3_num_detected == 0)) {
+        lavc_ac3_num_detected = sh_audio->channels;
+        audio_output_channels = sh_audio->channels;
+    }
 
     sh_audio->a_out_buffer_size = 0;
     sh_audio->a_out_buffer = NULL;
--- libaf/af_lavcac3enc.c.org	2009-03-30 12:33:51.000000000 -0400
+++ libaf/af_lavcac3enc.c	2009-03-30 12:37:22.000000000 -0400
@@ -46,6 +46,8 @@
 } af_ac3enc_t;
 
 extern int  avcodec_initialized;
+int lavc_ac3_detect = 0;
+int lavc_ac3_num_detected = 0;
 
 // Initialization and runtime control
 static int control(struct af_instance_s *af, int cmd, void *arg)
@@ -127,6 +129,12 @@
         }
         if (s->min_channel_num == 0)
             s->min_channel_num = 5;
+
+        if (lavc_ac3_detect) {
+            mp_msg(MSGT_AFILTER, MSGL_V, "af_lavcac3enc using auto-detect on channels: %d\n", lavc_ac3_num_detected);
+            s->min_channel_num = lavc_ac3_num_detected;
+        }
+
         mp_msg(MSGT_AFILTER, MSGL_V, "af_lavcac3enc config spdif:%d, bitrate:%d, "
                "minchnum:%d.\n", s->add_iec61937_header, s->bit_rate,
                s->min_channel_num);
