--- libmpdemux/mpeg_hdr.c.org	2011-08-29 23:21:54.751742715 -0400
+++ libmpdemux/mpeg_hdr.c	2011-08-29 23:21:33.257742707 -0400
@@ -409,6 +409,10 @@
 {
   unsigned int n = 0, v, i, k, mbh;
   int frame_mbs_only;
+  unsigned char * _tmp_buf = malloc(len);
+
+  memcpy(_tmp_buf, buf, len);
+  buf = _tmp_buf;
 
   len = mp_unescape03(buf, len);
 
@@ -465,6 +469,9 @@
   if(getbits(buf, n++, 1))
     n = h264_parse_vui(picture, buf, n);
 
+  if (_tmp_buf)
+    free(_tmp_buf);
+
   return n;
 }
 
--- libmpdemux/demux_ts.c.org	2011-09-30 00:18:08.000000000 -0400
+++ libmpdemux/demux_ts.c	2011-09-30 00:17:22.000000000 -0400
@@ -62,6 +62,8 @@
 int ts_keep_broken=0;
 off_t ts_probe = 0;
 int audio_substream_id = -1;
+int first_apid = 0;
+int last_fscod = -1;
 
 typedef enum
 {
@@ -835,11 +837,25 @@
 
 			if(is_audio)
 			{
-				if((req_apid == -1) || (req_apid == es.pid))
+				int fscod = -1;
+				if (es.start[0] == 0x0b && es.start[1] == 0x77 && es.start[2] && es.start[3])
+				{
+					fscod = es.start[4] & 0x3F;
+				}
+
+				if(((req_apid == -1) || (req_apid == es.pid)) && !first_apid)
 				{
 					param->atype = IS_AUDIO(es.type) ? es.type : es.subtype;
-					param->apid = es.pid;
+					first_apid = param->apid = es.pid;
 					audio_found = 1;
+					last_fscod = fscod;
+				}
+
+				if (last_fscod > 0 && fscod > 0 && fscod > last_fscod)
+				{
+					param->atype = IS_AUDIO(es.type) ? es.type : es.subtype;
+					req_apid = first_apid = param->apid = es.pid;
+					last_fscod = fscod;
 				}
 			}
 
--- libmpdemux/demux_ts.c.org	2012-04-01 00:45:37.000000000 -0400
+++ libmpdemux/demux_ts.c	2012-04-01 00:44:34.000000000 -0400
@@ -1604,7 +1633,10 @@
 		if(type_from_pmt != UNKNOWN)
 			es->type = type_from_pmt;
 		else
-			es->type    = AUDIO_MP2;
+            if (p[0] == 0xFF  && (p[1] == 0xF0 || p[1] == 0xF1))
+                es->type = AUDIO_AAC;
+			else
+				es->type    = UNKNOWN;
 
 		es->payload_size -= packet_len;
 
--- libmpdemux/demux_ts.c.org	2013-04-19 01:01:24.970111468 -0400
+++ libmpdemux/demux_ts.c	2013-04-19 01:02:57.123109454 -0400
@@ -336,6 +336,7 @@
 
 static int parse_avc_sps(uint8_t *buf, int len, int *w, int *h);
 static inline uint8_t *pid_lang_from_pmt(ts_priv_t *priv, int pid);
+static void demux_seek_resync_ts(demuxer_t *);
 
 static void ts_add_stream(demuxer_t * demuxer, ES_stream_t *es)
 {
@@ -3148,6 +3149,14 @@
 			}
 			else
 			{
+				if (tss->last_pts && (fabs(es->pts - tss->last_pts) > 2))
+				{
+					printf("sync? pts: %0.2f (%0.2f) -- %0.2f\n", es->pts, tss->last_pts, es->pts - tss->last_pts);
+					es->pts = tss->pts = tss->last_pts = 0;
+					demux_seek_resync_ts(demuxer);
+					continue;
+				}
+
 				if(es->pts == 0.0)
 					es->pts = tss->pts = tss->last_pts;
 				else
